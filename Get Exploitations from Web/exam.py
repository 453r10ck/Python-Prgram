#!/usr/bin/env python3
import requests
import html
import re
import os
import sys

path = './exploit-db'
if not os.path.exists(path):
    os.makedirs(path)

def exploit_func(id):
    #id = '1234'
    url = 'https://exploit-db.com/exploits/{}'.format(id)
    headers = {'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'}
    res = requests.get(url, headers = headers)
    exploit = res.text[res.text.find('<code') : res.text.find('</code>')]
    exploit = html.unescape(exploit[exploit.find('">') +2 :])
    
    with open(f'{path}/{id}.txt','w') as file:
        file.write(exploit)
         
    os.system(f"mousepad {path}/{id}.txt") #open with editor in new window
    
def page_func(id):
    file_id = []
    files = os.listdir(path)
    for i in range(len(files)):
        filename = files[i].split(".") # [filename_id, filename_extension]
        files[i] = filename[0]
        
    files = sorted(list(map(int,files)))
    files = list(map(str,files))
    
    for i in range(int(id)*5, min(len(files), int(id)*5+5)):
        file_id.append(files[i])
    
    print("\n".join(file_id))

def search_func(keyword):
    ls = []
    keyw = []
    keyw = keyword.split()
            
    for file in os.listdir(path):
        with open(f'{path}/{file}','r') as thefile:
            content = thefile.read()
            for k in range(len(keyw)):
                if re.findall(rf'(?<![a-zA-Z0-9])({keyw[k]})(?![a-zA-Z0-9])',content)!=[]: #note: there, here
                    ls.append(file)
                    break
        
    if len(ls)>0:
        for i in range(len(ls)):
            print(f'{path}/{ls[i]}')
    else:
        print("Your keywords were not found!!!")
    
def handle_input(string):
    #create a dict with keys(option) and values(argument)
    dict = {'--exploit':None,'--page':None,'--search':None}

    if re.findall(r'--exploit\s\d+',string): #priority 1
        io = re.findall(r'--exploit\s\d+',string)
        io = io[0].split()
        dict['--exploit'] = int(io[1])
    else:
        if re.findall(r'--page\s\d+',string): #priority 2
            io = re.findall(r'--page\s\d+',string)
            io = io[0].split()
            dict['--page'] = int(io[1])
        else:
            if re.search(r'(--search\s.+)(\s--)?',string)!=None: #priority 3
                io = re.findall(r'--search\s(.+)(\s--)?',string)
                dict['--search'] = list(io[0])[0]         
    return dict

def print_help():
    print("usage: -h  --exploit [ID]  --page [ID]  --search [keyword]")
    print("optional argument:")
    print("    -h HELP")
    print("   --exploit [ID]        get exploitations information from url")
    print("   --page [ID]           show the exploitations of the page")
    print("   --searhch [keyword]   search keyword in exploitattion files")
    
if __name__ == '__main__':
    #get input from command line
    arg = sys.argv # arg = ['exam.py','string1',....]
    string = " ".join(arg) 
    args = {}
    args = handle_input(string)
    
    if args['--exploit']==None and args['--search']==None and args['--page']==None:
        print_help()    
    else:
        if args['--exploit']!=None:
            id = args['--exploit']
            if f'{path}/{id}.txt' in os.listdir(path): #check wether the file exists or not 
                with open(f'{path}/{id}.txt','r') as file: #exists --> open
                    print(os.system(f"mousepad {id}.txt"))
            else: #not exists
                exploit_func(id)
                
        if args['--page']!=None:
            page_func(args['--page'])
        
        if args['--search']!=None:
            search_func(args['--search'])

                     
            
            
            
